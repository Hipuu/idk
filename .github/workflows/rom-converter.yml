name: ROM Converter

on:
  workflow_dispatch:
    inputs:
      rom_url:
        description: 'Direct download URL for base ROM'
        required: true
        type: string
      rom_type:
        description: 'ROM type (super or recovery)'
        required: true
        type: choice
        options:
          - super
          - recovery
      user_id:
        description: 'Telegram user ID'
        required: true
        type: string
      chat_id:
        description: 'Telegram chat ID'
        required: true
        type: string

jobs:
  convert-rom:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # 6 hours max
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            android-sdk-libsparse-utils \
            brotli \
            unzip \
            zip \
            python3-pip \
            aria2 \
            wget \
            curl \
            e2fsprogs
      
      - name: Install lpunpack and lpmake alternatives
        run: |
          # Install Python-based ROM tools
          pip3 install --upgrade pip
          pip3 install protobuf bsdiff4
          
          # Download payload-dumper-go (better alternative for extracting OTA/super images)
          cd /tmp
          wget https://github.com/ssut/payload-dumper-go/releases/download/1.3.0/payload-dumper-go_1.3.0_linux_amd64.tar.gz
          tar -xzf payload-dumper-go_1.3.0_linux_amd64.tar.gz
          sudo install -m 755 payload-dumper-go /usr/local/bin/
          
          # For lpunpack/lpmake, use Android platform tools method
          # Download directly from Android developers
          cd /tmp
          wget https://dl.google.com/android/repository/platform-tools_r35.0.2-linux.zip
          unzip -q platform-tools_r35.0.2-linux.zip
          
          # Copy fastboot which includes partition management
          sudo cp platform-tools/fastboot /usr/local/bin/
          sudo cp platform-tools/adb /usr/local/bin/
          
          # Verify installation
          which payload-dumper-go && echo "✓ payload-dumper-go installed"
          which simg2img && echo "✓ simg2img available from android-sdk-libsparse-utils"
          which fastboot && echo "✓ fastboot installed"
      
      - name: Install rclone
        run: |
          curl https://rclone.org/install.sh | sudo bash
      
      - name: Configure rclone
        env:
          RCLONE_CONFIG: ${{ secrets.RCLONE_CONFIG }}
        run: |
          # Check if RCLONE_CONFIG secret is set
          if [ -z "$RCLONE_CONFIG" ]; then
            echo "ERROR: RCLONE_CONFIG secret is not set!"
            echo "Please configure the following GitHub secrets:"
            echo "  1. RCLONE_CONFIG (base64 encoded rclone.conf)"
            echo "  2. DRIVE_FOLDER_PATH (e.g., ROM_Builds)"
            echo "  3. RCLONE_REMOTE_NAME (e.g., gdrive)"
            echo ""
            echo "See DEPLOYMENT.md for setup instructions"
            exit 1
          fi
          
          # Decode and save rclone config
          mkdir -p ~/.config/rclone
          echo "$RCLONE_CONFIG" | base64 -d > ~/.config/rclone/rclone.conf
          
          # Verify config was created
          if [ ! -f ~/.config/rclone/rclone.conf ]; then
            echo "ERROR: Failed to create rclone config file"
            exit 1
          fi
          
          echo "✓ Rclone configured successfully"
      
      - name: Download ROM
        id: download
        run: |
          # Check initial disk space
          echo "Initial disk space:"
          df -h
          echo ""
          
          echo "Downloading ROM from: ${{ github.event.inputs.rom_url }}"
          mkdir -p downloads
          cd downloads
          
          # Use aria2c for faster downloads with resume capability
          aria2c -x 16 -s 16 -k 1M "${{ github.event.inputs.rom_url }}" -o base_rom.zip
          
          echo "Download complete!"
          ls -lh base_rom.zip
          
          # Verify download
          if [ ! -f "base_rom.zip" ]; then
            echo "Error: Download failed!"
            exit 1
          fi
          
          echo "rom_path=$(pwd)/base_rom.zip" >> $GITHUB_OUTPUT
          
          # Check disk space after download
          echo ""
          echo "Disk space after download:"
          df -h
      
      - name: Free up disk space
        run: |
          echo "Cleaning up to free disk space..."
          
          # Remove unnecessary system files
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force
          
          echo ""
          echo "Disk space after cleanup:"
          df -h
      
      - name: Extract ROM metadata
        id: metadata
        run: |
          python3 scripts/extract_rom_info.py downloads/base_rom.zip ${{ github.event.inputs.rom_type }} > metadata.json
          cat metadata.json
          
          # Extract filename from JSON
          FILENAME=$(python3 -c "import json; print(json.load(open('metadata.json'))['filename'])")
          echo "output_filename=$FILENAME" >> $GITHUB_OUTPUT
          echo "Output filename will be: $FILENAME"
      
      - name: Convert to Super ROM
        if: github.event.inputs.rom_type == 'super'
        run: |
          echo "Starting Super ROM conversion..."
          df -h
          
          chmod +x scripts/convert_to_super.sh
          bash scripts/convert_to_super.sh downloads/base_rom.zip output
          
          # Clean up immediately after conversion
          rm -f downloads/base_rom.zip
          echo ""
          echo "Disk space after conversion:"
          df -h
      
      - name: Convert to Recovery ROM
        if: github.event.inputs.rom_type == 'recovery'
        run: |
          echo "Starting Recovery ROM conversion..."
          df -h
          
          chmod +x scripts/convert_to_recovery.sh
          bash scripts/convert_to_recovery.sh downloads/base_rom.zip output
          
          # Clean up immediately after conversion
          rm -f downloads/base_rom.zip
          echo ""
          echo "Disk space after conversion:"
          df -h
      
      - name: Create final package
        id: package
        run: |
          mkdir -p final
          cd output
          
          if [ "${{ github.event.inputs.rom_type }}" == "super" ]; then
            # Package super ROM
            zip -r ../final/${{ steps.metadata.outputs.output_filename }} *
          else
            # Hybrid ROM is already zipped
            mv *.zip ../final/${{ steps.metadata.outputs.output_filename }} || true
            # If not zipped, create zip
            if [ ! -f "../final/${{ steps.metadata.outputs.output_filename }}" ]; then
              zip -r ../final/${{ steps.metadata.outputs.output_filename }} *
            fi
          fi
          
          cd ../final
          ls -lh
          
          # Generate MD5 and SHA256 checksums
          md5sum ${{ steps.metadata.outputs.output_filename }} > ${{ steps.metadata.outputs.output_filename }}.md5
          sha256sum ${{ steps.metadata.outputs.output_filename }} > ${{ steps.metadata.outputs.output_filename }}.sha256
      
      - name: Upload to Google Drive
        id: upload
        env:
          DRIVE_FOLDER: ${{ secrets.DRIVE_FOLDER_PATH }}
          RCLONE_REMOTE: ${{ secrets.RCLONE_REMOTE_NAME }}
        run: |
          chmod +x scripts/upload_to_drive.sh
          
          # Upload and get shareable link
          DRIVE_LINK=$(bash scripts/upload_to_drive.sh \
            final/${{ steps.metadata.outputs.output_filename }} \
            "${RCLONE_REMOTE:-bot}:${DRIVE_FOLDER:-ROM_Builds}")
          
          echo "drive_link=$DRIVE_LINK" >> $GITHUB_OUTPUT
          echo "Download link: $DRIVE_LINK"
          
          # Also upload checksums
          rclone copy final/${{ steps.metadata.outputs.output_filename }}.md5 \
            "${RCLONE_REMOTE:-bot}:${DRIVE_FOLDER:-ROM_Builds}/"
          rclone copy final/${{ steps.metadata.outputs.output_filename }}.sha256 \
            "${RCLONE_REMOTE:-bot}:${DRIVE_FOLDER:-ROM_Builds}/"
          
          echo ""
          echo "=== Conversion Complete ==="
          echo "ROM: ${{ steps.metadata.outputs.output_filename }}"
          echo "Type: ${{ github.event.inputs.rom_type }}"
          echo "Download: $DRIVE_LINK"
      
      - name: Cleanup
        if: always()
        run: |
          rm -rf downloads output final
          echo "Cleanup complete!"
